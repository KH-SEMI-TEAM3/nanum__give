<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.kh.semi.board.model.mapper.NoticeBoardMapper">

    <select id="getNoticeListCount" resultType="int">
        SELECT COUNT(*) FROM "BOARD"
        WHERE BOARD_DEL_FL = 'N' AND BOARD_CODE = 3
    </select>

    <select id="selectNoticeList" resultType="Board">
        SELECT B.BOARD_NO, B.BOARD_TITLE, B.READ_COUNT, M.MEMBER_NICKNAME,
<![CDATA[
			CASE 
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1/24/60 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24*60*60) || '초 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1/24 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24*60) || '분 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24) || '시간 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 30 THEN FLOOR(SYSDATE - B.BOARD_WRITE_DATE) || '일 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 365 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)/30) || '달 전'
			  ELSE FLOOR((SYSDATE - B.BOARD_WRITE_DATE)/365) || '년 전'
			END AS BOARD_WRITE_DATE
		]]>

        FROM "BOARD" B
        JOIN "MEMBER" M ON B.MEMBER_NO = M.MEMBER_NO
        WHERE B.BOARD_DEL_FL = 'N' AND B.BOARD_CODE = 3
        ORDER BY B.BOARD_NO DESC
    </select>
    
    	<!-- 검색 조건이 맞는 게시글 수 조회 -->
	<select id="getnoticeSearchCount">
		SELECT COUNT(*)
		FROM "BOARD"
		WHERE BOARD_DEL_FL = 'N'
   		AND BOARD_CODE = #{boardCode}
		<choose>
			<!-- 제목 검색 (key 값 "t" 인 경우) -->
			<when test='key == "t"'>
				AND BOARD_TITLE LIKE '%'|| #{query} ||'%'
			</when>
			
			<!-- 내용 검색 (key 값 "c" 인 경우) -->
			<when test='key == "c"'>
				AND BOARD_CONTENT LIKE '%'|| #{query} ||'%'
			</when>
	</choose>
	
	</select>
	
	
	
	<select id="selectNoticeSearchList">
		SELECT BOARD_NO, BOARD_TITLE, READ_COUNT, MEMBER_NICKNAME,
		(SELECT
		COUNT(*)
		FROM "COMMENT" C
		WHERE C.BOARD_NO = B.BOARD_NO) COMMENT_COUNT,
		
	<![CDATA[
			CASE 
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1/24/60 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24*60*60) || '초 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1/24 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24*60) || '분 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24) || '시간 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 30 THEN FLOOR(SYSDATE - B.BOARD_WRITE_DATE) || '일 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 365 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)/30) || '달 전'
			  ELSE FLOOR((SYSDATE - B.BOARD_WRITE_DATE)/365) || '년 전'
			END AS BOARD_WRITE_DATE
		]]>

		FROM "BOARD" B
		JOIN "MEMBER" M ON(B.MEMBER_NO = M.MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
		
		<choose>
			<!-- 제목 검색 (key 값 "t" 인 경우) -->
			<when test='key == "t"'>
				AND BOARD_TITLE LIKE '%'|| #{query} ||'%'
			</when>
			
			<!-- 내용 검색 (key 값 "c" 인 경우) -->
			<when test='key == "c"'>
				AND BOARD_CONTENT LIKE '%'|| #{query} ||'%'
			</when>
			
	
		</choose>
		
		ORDER BY BOARD_NO DESC
	</select>
	
	<!-- 상세 조회 -->

    <select id="selectNoticeDetail" resultType="Board">
        SELECT B.BOARD_NO, B.BOARD_TITLE, B.BOARD_CONTENT,
              BOARD_WRITE_DATE, M.MEMBER_NO,
               B.READ_COUNT, M.MEMBER_NICKNAME
        FROM "BOARD" B
        JOIN "MEMBER" M ON B.MEMBER_NO = M.MEMBER_NO
        WHERE B.BOARD_NO = #{boardNo} AND B.BOARD_CODE = 3
          AND B.BOARD_DEL_FL = 'N'
    </select>

    <update id="updateReadCount">
        UPDATE "BOARD" SET READ_COUNT = READ_COUNT + 1
        WHERE BOARD_NO = #{boardNo}
    </update>


		<!-- 상세 조회한 게시글의 댓글 목록 조회 -->
	<select id="selectCommentList" resultType="Comment">
		SELECT LEVEL, C.* FROM
		(SELECT COMMENT_NO, COMMENT_CONTENT,
		TO_CHAR(COMMENT_WRITE_DATE, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분" SS"초"') COMMENT_WRITE_DATE,
		BOARD_NO, MEMBER_NO, MEMBER_NICKNAME, MEMBER_IMG, 
		PARENT_COMMENT_NO, COMMENT_DEL_FL
		FROM "COMMENT"
		JOIN MEMBER USING(MEMBER_NO)
		WHERE BOARD_NO = #{boardNo}) C
		WHERE COMMENT_DEL_FL = 'N'
		OR 0 != (SELECT COUNT(*) FROM "COMMENT" SUB
						WHERE SUB.PARENT_COMMENT_NO = C.COMMENT_NO
						AND COMMENT_DEL_FL = 'N')
		START WITH PARENT_COMMENT_NO IS NULL
		CONNECT BY PRIOR COMMENT_NO = PARENT_COMMENT_NO
		ORDER SIBLINGS BY COMMENT_NO
	</select>
	
<!-- 검색 결과 개수 조회 -->
<select id="getSearchCount" resultType="_int">
    SELECT COUNT(*) FROM BOARD
    WHERE BOARD_DEL_FL = 'N'
    AND BOARD_CODE = 3
    AND (BOARD_TITLE LIKE '%' || #{query} || '%' OR BOARD_CONTENT LIKE '%' || #{query} || '%')
</select>

<!-- 검색 결과 목록 조회 (페이지네이션 포함) -->
<select id="searchByKeyword" resultType="Board">
    SELECT B.BOARD_NO,
           B.BOARD_TITLE,
           B.MEMBER_NO,
           M.MEMBER_NICKNAME,
           TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD') AS BOARD_WRITE_DATE,
           B.READ_COUNT
    FROM BOARD B
    JOIN MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
    WHERE B.BOARD_DEL_FL = 'N'
      AND B.BOARD_CODE = 3
      AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
    ORDER BY B.BOARD_NO DESC
</select>

<select id="selectByMember" resultType="Board">
  SELECT * FROM BOARD
  WHERE MEMBER_NO = #{memberNo}
  AND BOARD_CODE = 3
  AND BOARD_DEL_FL = 'N'
  ORDER BY BOARD_NO DESC
</select>


<!-- 게시글 상세조회 -->
<select id="selectOne" parameterType="map" resultType="Board">
  SELECT *
  FROM "BOARD"
  WHERE BOARD_NO = #{boardNo}
    AND BOARD_CODE = #{boardCode}
    AND BOARD_DEL_FL = 'N'
</select>


	



</mapper>
