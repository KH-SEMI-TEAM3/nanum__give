<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="edu.kh.semi.board.model.mapper.FreeBoardMapper">

	<!-- 게시글 전체 수 조회 (페이징 계산용) -->
	<select id="selectFreeListCount" resultType="int">
		SELECT COUNT(*)
		FROM
		BOARD
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = 2
	</select>

	<!-- 자유게시판 페이징 목록 조회 -->
	<select id="selectFreeList" parameterType="Pagination"
		resultType="Board">
		SELECT
		B.BOARD_NO,
		B.BOARD_TITLE,
		B.BOARD_CONTENT,
		      (SELECT COUNT(*) 
     FROM "COMMENT" C 
     WHERE C.BOARD_NO = B.BOARD_NO AND C.COMMENT_DEL_FL = 'N') AS COMMENT_COUNT,
<![CDATA[
			CASE 
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1/24/60 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24*60*60) || '초 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1/24 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24*60) || '분 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 1 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)*24) || '시간 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 30 THEN FLOOR(SYSDATE - B.BOARD_WRITE_DATE) || '일 전'
			  WHEN SYSDATE - B.BOARD_WRITE_DATE < 365 THEN FLOOR((SYSDATE - B.BOARD_WRITE_DATE)/30) || '달 전'
			  ELSE FLOOR((SYSDATE - B.BOARD_WRITE_DATE)/365) || '년 전'
			END AS BOARD_WRITE_DATE
		]]>,
		B.READ_COUNT,
		M.MEMBER_NICKNAME,
		M.MEMBER_IMG AS
		memberImg
		FROM BOARD B
		JOIN MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
		WHERE
		B.BOARD_DEL_FL = 'N'
		AND B.BOARD_CODE = 2
		ORDER BY B.BOARD_NO DESC
		OFFSET #{startRow} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>

	<!-- 자유게시판 글쓰기 -->
	<insert id="insertFreeBoard" parameterType="Board">
		<!-- Oracle에서는 반드시 selectKey 사용 -->
		<selectKey keyProperty="boardNo" resultType="int"
			order="BEFORE">
			SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
		</selectKey>

		INSERT INTO BOARD (
		BOARD_NO,
		BOARD_TITLE, BOARD_CONTENT,
		MEMBER_NO,
		BOARD_CODE, READ_COUNT,
		BOARD_DEL_FL, BOARD_WRITE_DATE
		) VALUES (
		#{boardNo},
		#{boardTitle},
		#{boardContent},
		#{memberNo},
		#{boardCode},
		0,
		'N',
		SYSDATE
		)
	</insert>



	<resultMap id="board_rm" type="Board">
		<id property="boardNo" column="BOARD_NO" />
		<result property="boardTitle" column="BOARD_TITLE" />
		<result property="boardContent" column="BOARD_CONTENT" />
		<result property="boardWriteDate" column="BOARD_WRITE_DATE" />
		<result property="boardUpdateDate" column="BOARD_UPDATE_DATE" />
		<result property="readCount" column="READ_COUNT" />
		<result property="boardDelFl" column="BOARD_DEL_FL" />
		<result property="boardCode" column="BOARD_CODE" />
		<result property="memberNo" column="MEMBER_NO" />
		<result property="qaStatus" column="QA_STATUS" />

		<result property="memberNickname" column="MEMBER_NICKNAME" />

		<result property="memberImg" column="MEMBER_IMG" />
		<result property="thumbnail" column="THUMBNAIL" />

	</resultMap>

	<select id="selectFreeBoard" parameterType="int"
		resultMap="board_rm">
		SELECT
		B.BOARD_NO,
		B.BOARD_TITLE,
		B.BOARD_CONTENT,
		B.BOARD_WRITE_DATE AS BOARD_WRITE_DATE,
		B.BOARD_UPDATE_DATE,
		B.READ_COUNT,
		B.BOARD_DEL_FL,
		B.BOARD_CODE,
		B.MEMBER_NO,
		B.QA_STATUS,
		M.MEMBER_NICKNAME,
		M.MEMBER_IMG AS
		MEMBER_IMG,
		(
		SELECT IMG_PATH ||
		IMG_RENAME
		FROM BOARD_IMAGE
		WHERE
		BOARD_NO = B.BOARD_NO
		AND IMG_ORDER = 0
		) AS THUMBNAIL
		FROM BOARD B
		JOIN
		MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
		WHERE B.BOARD_NO = #{boardNo}
	</select>

	<!-- 자유게시판 게시글 수정 -->
	<update id="updateFreeBoard" parameterType="Board">
		UPDATE BOARD
		SET
		BOARD_TITLE = #{boardTitle},
		BOARD_CONTENT =
		#{boardContent},
		BOARD_UPDATE_DATE = SYSDATE
		<if test="thumbnail != null">
			, THUMBNAIL = #{thumbnail}
		</if>
		WHERE
		BOARD_NO = #{boardNo}
		AND BOARD_CODE = 2
	</update>

	<!-- 자유 게시판 검색 -->
	<select id="searchByKeyword" resultType="Board">
		SELECT
		B.BOARD_NO,
		B.BOARD_TITLE,
		TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS
		BOARD_WRITE_DATE,
		B.READ_COUNT,
		M.MEMBER_NICKNAME
		FROM BOARD B
		JOIN MEMBER
		M ON B.MEMBER_NO = M.MEMBER_NO
		WHERE B.BOARD_TITLE LIKE '%' || #{query}
		|| '%'
		AND B.BOARD_CODE = 2
		AND B.BOARD_DEL_FL = 'N'
		ORDER BY B.BOARD_NO
		DESC
	</select>

	<select id="countSearch" resultType="int">
		SELECT COUNT(*)
		FROM BOARD
		WHERE BOARD_TITLE LIKE '%' || #{query} || '%'
		AND BOARD_CODE = 2
		AND BOARD_DEL_FL = 'N'
	</select>

	<!-- 조회수 증가 -->
	<update id="updateReadCount" parameterType="int">
		UPDATE BOARD
		SET
		READ_COUNT = READ_COUNT + 1
		WHERE BOARD_NO = #{boardNo}
	</update>

	<select id="selectByMember" resultType="Board">
		SELECT * FROM BOARD
		WHERE
		MEMBER_NO = #{memberNo}
		AND BOARD_CODE = 2
		AND BOARD_DEL_FL = 'N'
		ORDER
		BY BOARD_NO DESC
	</select>

	<!-- 게시판 삭제 -->
	<update id="deleteBoard" parameterType="int">
		UPDATE BOARD SET
		BOARD_DEL_FL = 'Y' WHERE BOARD_NO = #{boardNo}
	</update>

	<!-- 이미지 수정 -->
	<!-- 기존 이미지 삭제 -->
	<delete id="deleteBoardImage" parameterType="int">
		DELETE FROM
		BOARD_IMAGE
		WHERE BOARD_NO = #{boardNo}
	</delete>
	<!-- 새 이미지 삽입 -->
	<insert id="insertBoardImage" parameterType="BoardImg">
		INSERT INTO
		BOARD_IMAGE (
		IMG_NO,
		IMG_PATH,
		IMG_ORIGINAL_NAME,
		IMG_RENAME,
		IMG_ORDER,
		BOARD_NO
		) VALUES (
		SEQ_IMG_NO.NEXTVAL,
		#{imgPath},
		#{imgOriginalName},
		#{imgRename},
		#{imgOrder},
		#{boardNo}
		)
	</insert>


	<!-- 자유게시판 조건 검색 쿼리 (key: title/content 분기) -->
	<select id="searchByKeyAndQuery" resultType="Board"
		parameterType="map">
		SELECT
		B.BOARD_NO,
		B.BOARD_TITLE,
		TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD
		HH24:MI:SS') AS BOARD_WRITE_DATE,
		B.READ_COUNT,
		M.MEMBER_NICKNAME
		FROM
		BOARD B
		JOIN MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
		WHERE B.BOARD_CODE =
		2
		AND B.BOARD_DEL_FL = 'N'
		<choose>
			<when test="key == 'title'">
				AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
			</when>
			<when test="key == 'content'">
				AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
			</when>
		</choose>
		ORDER BY B.BOARD_NO DESC
	</select>

	<!-- 자유게시판 조건 검색 결과 수 카운트 -->
	<select id="countSearchByKey" resultType="int"
		parameterType="map">
		SELECT COUNT(*)
		FROM BOARD
		WHERE BOARD_CODE = 2
		AND BOARD_DEL_FL = 'N'
		<choose>
			<when test="key == 'title'">
				AND BOARD_TITLE LIKE '%' || #{query} || '%'
			</when>
			<when test="key == 'content'">
				AND BOARD_CONTENT LIKE '%' || #{query} || '%'
			</when>
		</choose>
	</select>

	<!-- 삭제된 회원 여부 -->
	<select id="selectMemberDelFl" resultType="String">
		SELECT MEMBER_DEL_FL
		FROM MEMBER
		WHERE MEMBER_NO = #{memberNo}
	</select>

</mapper>
