<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>공지사항 수정</title>

    <th:block th:replace="~{common/common}"></th:block>
    <link rel="stylesheet" th:href="@{/css/board/boardWrite-style.css}" />
    <link rel="stylesheet" th:href="@{/css/notice/noticewrite.css}" />

    <!-- Summernote CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css"
      rel="stylesheet"
    />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Summernote JS -->
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
  </head>
  <body>
    <main>
      <th:block th:replace="~{common/header}"></th:block>

      <form
        th:action="@{'/noticeEdit/' + ${board.boardNo} + '/update'}"
        method="POST"
        enctype="multipart/form-data"
        class="board-write"
        id="boardUpdateFrm"
      >
        <!-- 제목 -->
        <h1 class="board-title">
          <input
            type="text"
            name="boardTitle"
            placeholder="제목"
            th:value="${board?.boardTitle}"
          />
        </h1>

        <!-- 내용 -->
        <div class="board-content">
          <textarea
            id="summernote"
            name="boardContent"
            th:text="${board?.boardContent}"
          ></textarea>
        </div>

        <!-- 버튼 영역 -->
        <div class="board-btn-area">
          <button type="submit" id="updateBtn">수정 완료</button>
        </div>
      </form>
    </main>

    <th:block th:replace="~{common/footer}"></th:block>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("boardUpdateFrm");
        const titleInput = form.querySelector("input[name='boardTitle']");

        form.addEventListener("submit", function (e) {
          const contentHtml = $("#summernote").summernote("code");
          const contentText = $("<div>").html(contentHtml).text().trim();

          if (titleInput.value.trim().length === 0) {
            alert("제목을 입력하세요.");
            e.preventDefault();
            return;
          }

          if (titleInput.value.trim().length > 100) {
            alert("제목은 100자까지 입력 가능합니다.");
            e.preventDefault();
            return;
          }

          if (contentText.length === 0 || contentHtml === "<p><br></p>") {
            alert("내용을 입력하세요.");
            e.preventDefault();
            return;
          }

          if (contentText.length > 200) {
            alert("내용은 200자까지 입력 가능합니다.");
            e.preventDefault();
            return;
          }

          const files = $("input[type='file']")[0]?.files;
          if (files) {
            for (const file of files) {
              if (file.size > 30 * 1024 * 1024) {
                alert("이미지 파일은 30MB를 초과할 수 없습니다.");
                e.preventDefault();
                return;
              }
            }
          }
        });
      });

      $("#summernote").summernote({
        placeholder: "내용을 작성하세요",
        height: 600,
        lang: "ko-KR",
        toolbar: [
          ["style", ["style"]],
          ["font", ["bold", "underline", "clear"]],
          ["fontname", ["fontname"]],
          ["color", ["color"]],
          ["para", ["ul", "ol", "paragraph"]],
          ["insert", ["link", "picture"]],
          ["view", ["codeview"]],
        ],
        callbacks: {
          onImageUpload: function (files) {
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              if (!file.type.startsWith("image/")) {
                alert("이미지 파일만 업로드 가능합니다.");
                continue;
              }
              sendFile(file, this);
            }
          },
        },
      });

      function sendFile(file, editor) {
        const data = new FormData();
        data.append("image", file);

        $.ajax({
          url: "/noticeEdit/UploadImage",
          type: "POST",
          data: data,
          contentType: false,
          processData: false,
          success: function (url) {
            const img = $("<img>").attr("src", url).css({
              "max-width": "100%",
              display: "block",
              margin: "10px 0",
            });
            const wrapper = $("<p>").append(img);
            $(editor).summernote("insertNode", wrapper[0]);

            const cursorBreak = $("<p><br></p>");
            $(editor).summernote("insertNode", cursorBreak[0]);
          },
          error: function () {
            alert("이미지 업로드에 실패했습니다.");
          },
        });
      }
    </script>
  </body>
</html>
